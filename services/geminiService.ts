
import { GoogleGenAI } from "@google/genai";
import { Source } from "../types";

const API_KEY = process.env.API_KEY;

if (!API_KEY) {
  console.warn("API_KEY environment variable not set. Gemini API calls will use mock data.");
}

const ai = new GoogleGenAI({ apiKey: API_KEY! });

const systemInstruction = `You are an AI assistant for a civic engagement platform called 'Digital Democracy'. Your tone must be neutral, informative, and encouraging of constructive dialogue. Avoid partisan language, speculation, or inflammatory statements. When generating a post based on a topic, rely on the provided search results to ensure accuracy.`;

export const generatePostContent = async (topic?: string): Promise<{ text: string; sources: Source[] }> => {
  const prompt = topic 
    ? `Write a positive and engaging social media post for a political campaign about: "${topic}"`
    : `Write a positive and engaging social media post for a political campaign about improving local communities.`;
  
  if (!API_KEY) {
    console.log("Using mock response due to missing API key.");
    return new Promise(resolve => setTimeout(() => {
        resolve({
          text: `This is a mock AI-generated post about "${topic || 'local communities'}". In a real scenario, this would be generated by the Gemini model, grounded in real-time search results for accuracy and credibility.`,
          sources: [
            { title: "Mock Source 1: Community News", uri: "#" },
            { title: "Mock Source 2: City Council Report", uri: "#" }
          ]
        });
    }, 1000));
  }

  try {
    const response = await ai.models.generateContent({
      model: 'gemini-2.5-flash',
      contents: prompt,
      config: {
        systemInstruction,
        tools: [{googleSearch: {}}],
      }
    });

    const text = response.text;
    const groundingMetadata = response.candidates?.[0]?.groundingMetadata;
    
    let sources: Source[] = [];
    if (groundingMetadata?.groundingChunks) {
      sources = groundingMetadata.groundingChunks
        .filter(chunk => chunk.web)
        .map(chunk => ({
          title: chunk.web.title,
          uri: chunk.web.uri,
        }));
    }

    if (text) {
      return { text: text.trim(), sources };
    } else {
      throw new Error("Received an empty response from Gemini API.");
    }
  } catch (error) {
    console.error("Error generating content with Gemini:", error);
    throw new Error("Failed to generate content from Gemini API.");
  }
};
